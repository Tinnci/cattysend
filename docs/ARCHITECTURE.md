# ğŸ—ï¸ Cattysend Core æ¶æ„è®¾è®¡

> **å±‚çº§åŒ–æ¨¡å—è®¾è®¡æ–‡æ¡£** - ä»åº•å±‚åè®®åˆ°é«˜å±‚å·¥ä½œæµ

---

## ğŸ“Š æ¶æ„æ€»è§ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           Layer 4: Workflow (å·¥ä½œæµå±‚)                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚         Sender              â”‚  â”‚        Receiver             â”‚          â”‚
â”‚  â”‚  (å®Œæ•´å‘é€ç«¯å·¥ä½œæµ)           â”‚  â”‚  (å®Œæ•´æ¥æ”¶ç«¯å·¥ä½œæµ)           â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚                 â”‚                                 â”‚                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                 â–¼                                 â–¼                         â”‚
â”‚                           Layer 3: Transfer (ä¼ è¾“å±‚)                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚     TransferServer          â”‚  â”‚     ReceiverClient          â”‚          â”‚
â”‚  â”‚  (HTTP + WebSocket æœåŠ¡å™¨)   â”‚  â”‚  (HTTP + WebSocket å®¢æˆ·ç«¯)   â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚                                                                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                           Layer 2: Transport (ä¼ è¾“å±‚)                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚                         WiFi P2P Module                       â”‚         â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚         â”‚
â”‚  â”‚  â”‚ WiFiP2pSenderâ”‚  â”‚WiFiP2pReceiverâ”‚  â”‚     NmClient       â”‚    â”‚         â”‚
â”‚  â”‚  â”‚ (çƒ­ç‚¹åˆ›å»º)   â”‚  â”‚ (çƒ­ç‚¹è¿æ¥)    â”‚  â”‚ (NM D-Bus å®¢æˆ·ç«¯)   â”‚    â”‚         â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚                                                                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                           Layer 1: Discovery (å‘ç°å±‚)                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚                         BLE Module                            â”‚         â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚         â”‚
â”‚  â”‚  â”‚ BleScanner  â”‚  â”‚  BleClient  â”‚  â”‚    GattServer       â”‚    â”‚         â”‚
â”‚  â”‚  â”‚ (è®¾å¤‡æ‰«æ)   â”‚  â”‚ (GATTå®¢æˆ·ç«¯) â”‚  â”‚  (GATT æœåŠ¡å™¨)      â”‚    â”‚         â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚                                                                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                           Layer 0: Security (å®‰å…¨å±‚)                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚                        Crypto Module                          â”‚         â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚         â”‚
â”‚  â”‚  â”‚    BleSecurity      â”‚  â”‚     SessionCipher           â”‚     â”‚         â”‚
â”‚  â”‚  â”‚ (ECDH P-256 å¯†é’¥äº¤æ¢)â”‚  â”‚  (AES-256-CTR åŠ å¯†/è§£å¯†)    â”‚     â”‚         â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“ æ¨¡å—è¯¦è§£

### Layer 0: Security (å®‰å…¨å±‚)

**ä½ç½®**: `src/crypto/`

**èŒè´£**: æä¾›ç«¯åˆ°ç«¯åŠ å¯†ï¼Œä¿æŠ¤ä¼ è¾“è¿‡ç¨‹ä¸­çš„æ•æ„Ÿæ•°æ®

| ç»„ä»¶ | æ–‡ä»¶ | èŒè´£ |
|------|------|------|
| `BleSecurity` | `ble_security.rs` | ECDH P-256 å¯†é’¥å¯¹ç”Ÿæˆå’Œäº¤æ¢ |
| `BleSecurityPersistent` | `ble_security.rs` | å¯å¤ç”¨çš„å¯†é’¥ç®¡ç†å™¨ |
| `SessionCipher` | `ble_security.rs` | AES-256-CTR åŠ å¯†/è§£å¯† |

**å…³é”®è®¾è®¡å†³ç­–**:
- å…¬é’¥ä½¿ç”¨ **X.509 SPKI DER** æ ¼å¼ï¼ˆå…¼å®¹ Java/Kotlinï¼‰
- å›ºå®š IV = ASCII `"0102030405060708"`ï¼ˆå…¼å®¹ CatShareï¼‰
- **ä¸ä½¿ç”¨ HKDF**ï¼Œç›´æ¥ä½¿ç”¨ ECDH å…±äº«å¯†é’¥ï¼ˆå…¼å®¹ CatShareï¼‰

```rust
// ä½¿ç”¨ç¤ºä¾‹
let security = BleSecurity::new()?;
let public_key = security.get_public_key(); // Base64 ç¼–ç çš„å…¬é’¥

// å¯†é’¥äº¤æ¢
let cipher = security.derive_session_key(peer_public_key_b64)?;

// åŠ å¯†/è§£å¯†
let encrypted = cipher.encrypt("plaintext")?;
let decrypted = cipher.decrypt(&encrypted)?;
```

---

### Layer 1: Discovery (å‘ç°å±‚)

**ä½ç½®**: `src/ble/`

**èŒè´£**: BLE è®¾å¤‡å‘ç°ã€è¿æ¥å’Œ GATT æ“ä½œ

| ç»„ä»¶ | æ–‡ä»¶ | èŒè´£ |
|------|------|------|
| `BleScanner` | `scanner.rs` | æ‰«æå¸¦æœ‰ `SERVICE_UUID` çš„è®¾å¤‡ |
| `BleClient` | `client.rs` | è¿æ¥è®¾å¤‡ã€è¯»å–çŠ¶æ€ã€å†™å…¥ P2P ä¿¡æ¯ |
| `GattServer` | `server.rs` | GATT æœåŠ¡å™¨ï¼Œå“åº”æ‰«æå’Œå†™å…¥ |
| `DiscoveredDevice` | `scanner.rs` | å‘ç°çš„è®¾å¤‡ä¿¡æ¯ç»“æ„ |
| `DeviceInfo` | `mod.rs` | GATT STATUS ç‰¹å¾æ•°æ® |

**UUID å®šä¹‰**:
```rust
ADV_SERVICE_UUID  = 00003331-0000-1000-8000-008123456789  // å¹¿æ’­
SERVICE_UUID      = 00003331-0000-1000-8000-00805f9b34fb  // æ‰«æåŒ¹é…
MAIN_SERVICE_UUID = 00009955-0000-1000-8000-00805f9b34fb  // GATT ä¸»æœåŠ¡
STATUS_CHAR_UUID  = 00009954-0000-1000-8000-00805f9b34fb  // çŠ¶æ€ç‰¹å¾
P2P_CHAR_UUID     = 00009953-0000-1000-8000-00805f9b34fb  // P2P ç‰¹å¾
```

**çŠ¶æ€æœº**:
```
å‘é€ç«¯ (Sender)                           æ¥æ”¶ç«¯ (Receiver)
    |                                          |
    |--- BleScanner.scan() ------------------->|
    |                                          |--- GattServer.start()
    |<-- DiscoveredDevice --------------------|
    |                                          |
    |--- BleClient.connect() ----------------->|
    |--- read STATUS_CHAR -------------------->|
    |<-- DeviceInfo (å« public_key) -----------|
    |                                          |
    |--- ECDH å¯†é’¥äº¤æ¢ ------------------------>|
    |--- write P2P_CHAR (åŠ å¯†çš„ P2pInfo) ------>|
    |                                          |--- è§£å¯†å¹¶è·å– P2pInfo
```

---

### Layer 2: Transport (ä¼ è¾“å±‚)

**ä½ç½®**: `src/wifi/`

**èŒè´£**: WiFi P2P çƒ­ç‚¹åˆ›å»ºå’Œè¿æ¥

| ç»„ä»¶ | æ–‡ä»¶ | èŒè´£ |
|------|------|------|
| `NmClient` | `nm_dbus.rs` | NetworkManager D-Bus å®¢æˆ·ç«¯ |
| `WiFiP2pSender` | `p2p_sender.rs` | çƒ­ç‚¹åˆ›å»º (å‘é€ç«¯) |
| `WiFiP2pReceiver` | `p2p_receiver.rs` | çƒ­ç‚¹è¿æ¥ (æ¥æ”¶ç«¯) |
| `P2pInfo` | `mod.rs` | P2P è¿æ¥ä¿¡æ¯ç»“æ„ä½“ |
| `P2pConfig` | `p2p_sender.rs` | çƒ­ç‚¹é…ç½® |

**å±‚çº§å…³ç³»**:
```
WiFiP2pSender / WiFiP2pReceiver
          â”‚
          â–¼
     NmClient (ä¼˜å…ˆ)
          â”‚
          â”œâ”€â”€ create_hotspot() / create_wifi_connection()
          â”œâ”€â”€ activate_connection()
          â”œâ”€â”€ wait_for_ip()
          â””â”€â”€ delete_connection()
          â”‚
          â–¼ (fallback)
     wpa_cli / nmcli (å‘½ä»¤è¡Œ)
```

**NmClient D-Bus æ¥å£**:
```rust
// è®¾å¤‡å‘ç°
client.get_wifi_devices().await?        // è·å–æ‰€æœ‰ WiFi è®¾å¤‡
client.find_wifi_device(iface).await?   // æŒ‰æ¥å£åæŸ¥æ‰¾
client.find_p2p_device().await?         // æŸ¥æ‰¾ P2P è®¾å¤‡

// è¿æ¥ç®¡ç†
client.create_hotspot(ssid, psk, band, iface).await?
client.create_wifi_connection(ssid, psk, iface).await?
client.activate_connection(&conn, &device).await?
client.deactivate_connection(&active).await?
client.delete_connection(&conn).await?
client.delete_connection_by_name(name).await?

// æ‰«æå’ŒçŠ¶æ€
client.request_wifi_scan(&device).await?
client.wait_for_ip(&active, timeout).await?
client.disconnect_device(&device).await?
```

---

### Layer 3: Transfer (æ–‡ä»¶ä¼ è¾“å±‚)

**ä½ç½®**: `src/transfer/`

**èŒè´£**: HTTP/WebSocket æ–‡ä»¶ä¼ è¾“

| ç»„ä»¶ | æ–‡ä»¶ | èŒè´£ |
|------|------|------|
| `TransferServer` | `server.rs` | HTTP + WebSocket æœåŠ¡å™¨ |
| `ReceiverClient` | `receiver.rs` | HTTP + WebSocket å®¢æˆ·ç«¯ |
| `WsMessage` | `protocol.rs` | WebSocket æ¶ˆæ¯åè®® |
| `FileEntry` | `protocol.rs` | æ–‡ä»¶æ¡ç›®ç»“æ„ |
| `TransferTask` | `protocol.rs` | ä¼ è¾“ä»»åŠ¡çŠ¶æ€ |

**åè®®æµç¨‹**:
```
ReceiverClient                              TransferServer
     |                                            |
     |------ WebSocket CONNECT ------------------->|
     |<----- versionNegotiation -------------------|
     |------ versionNegotiation (å“åº”) ------------>|
     |                                            |
     |------ sendRequest (è¯·æ±‚å‘é€) --------------->|
     |<----- confirmReceive (ç¡®è®¤æ¥æ”¶) -------------|
     |                                            |
     |------ HTTP GET /download?taskId=xxx ------->|
     |<----- Chunked File Stream ------------------|
     |                                            |
     |------ finishReceive (å®Œæˆ) ----------------->|
```

---

### Layer 4: Workflow (å·¥ä½œæµå±‚)

**ä½ç½®**: `src/workflow/`

**èŒè´£**: å°è£…å®Œæ•´çš„å‘é€/æ¥æ”¶æµç¨‹

| ç»„ä»¶ | æ–‡ä»¶ | èŒè´£ |
|------|------|------|
| `Sender` | `sender.rs` | å®Œæ•´å‘é€ç«¯å·¥ä½œæµ |
| `Receiver` | `receiver.rs` | å®Œæ•´æ¥æ”¶ç«¯å·¥ä½œæµ |
| `SendProgressCallback` | `sender.rs` | å‘é€è¿›åº¦å›è°ƒ trait |
| `ReceiveProgressCallback` | `receiver.rs` | æ¥æ”¶è¿›åº¦å›è°ƒ trait |

**Sender å·¥ä½œæµ**:
```rust
pub async fn send_to_device<C: SendProgressCallback>(
    &self,
    device: &DiscoveredDevice,
    files: Vec<PathBuf>,
    callback: &C,
) -> Result<()> {
    // 1. åˆ›å»º WiFi P2P çƒ­ç‚¹
    let p2p_info = wifi_sender.create_group(port).await?;
    
    // 2. å¯åŠ¨ä¼ è¾“æœåŠ¡å™¨ (åå°)
    let server = TransferServer::new(files, port);
    server.start().await?;
    
    // 3. é€šè¿‡ BLE å‘é€ P2P ä¿¡æ¯
    let ble_client = BleClient::new().await?;
    ble_client.connect_and_handshake(&device.address, &p2p_info).await?;
    
    // 4. ç­‰å¾…ä¼ è¾“å®Œæˆ
    server.wait_for_completion().await?;
}
```

**Receiver å·¥ä½œæµ**:
```rust
pub async fn start<C: ReceiveProgressCallback>(
    &self,
    callback: &C,
) -> Result<Vec<PathBuf>> {
    // 1. å¯åŠ¨ GATT Server
    let gatt_server = GattServer::new(mac, name, public_key)?;
    gatt_server.start().await?;
    
    // 2. ç­‰å¾… P2P ä¿¡æ¯
    let p2p_info = p2p_rx.recv().await?;
    
    // 3. è¿æ¥åˆ°å‘é€ç«¯çƒ­ç‚¹
    let wifi_receiver = WiFiP2pReceiver::new(interface);
    let local_ip = wifi_receiver.connect(&p2p_info).await?;
    
    // 4. æ¥æ”¶æ–‡ä»¶
    let client = ReceiverClient::new(&sender_ip, port, output_dir);
    let files = client.start(&adapter).await?;
    
    // 5. æ¸…ç†
    wifi_receiver.disconnect().await?;
    
    Ok(files)
}
```

---

## ğŸ”„ æ•°æ®æµ

### å‘é€ç«¯å®Œæ•´æµç¨‹

```
                                  User App
                                     â”‚
                                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Sender (Workflow Layer)                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  1. WiFiP2pSender.create_group()                               â”‚
â”‚         â”‚                                                       â”‚
â”‚         â–¼                                                       â”‚
â”‚     NmClient.create_hotspot() â”€â”€â–º NetworkManager D-Bus         â”‚
â”‚         â”‚                                                       â”‚
â”‚         â–¼                                                       â”‚
â”‚  2. TransferServer.start() â”€â”€â–º axum HTTP + tokio-tungstenite   â”‚
â”‚         â”‚                                                       â”‚
â”‚         â–¼                                                       â”‚
â”‚  3. BleClient.connect_and_handshake()                           â”‚
â”‚         â”‚                                                       â”‚
â”‚         â”œâ”€â”€ read STATUS_CHAR (è·å–æ¥æ”¶ç«¯å…¬é’¥)                    â”‚
â”‚         â”œâ”€â”€ ECDH å¯†é’¥äº¤æ¢                                        â”‚
â”‚         â””â”€â”€ write P2P_CHAR (åŠ å¯†çš„ P2pInfo)                      â”‚
â”‚         â”‚                                                       â”‚
â”‚         â–¼                                                       â”‚
â”‚  4. ç­‰å¾…æ¥æ”¶ç«¯è¿æ¥å¹¶å®Œæˆä¼ è¾“                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ¥æ”¶ç«¯å®Œæ•´æµç¨‹

```
                                  User App
                                     â”‚
                                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Receiver (Workflow Layer)                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  1. GattServer.start() â”€â”€â–º bluer D-Bus (GATT Server)           â”‚
â”‚         â”‚                                                       â”‚
â”‚         â–¼                                                       â”‚
â”‚  2. ç­‰å¾… P2P ä¿¡æ¯ (via P2P_CHAR å†™å…¥)                            â”‚
â”‚         â”‚                                                       â”‚
â”‚         â–¼                                                       â”‚
â”‚  3. WiFiP2pReceiver.connect()                                   â”‚
â”‚         â”‚                                                       â”‚
â”‚         â–¼                                                       â”‚
â”‚     NmClient.create_wifi_connection() â”€â”€â–º NetworkManager D-Bus â”‚
â”‚         â”‚                                                       â”‚
â”‚         â–¼                                                       â”‚
â”‚  4. ReceiverClient.start()                                      â”‚
â”‚         â”‚                                                       â”‚
â”‚         â”œâ”€â”€ WebSocket æ¡æ‰‹                                       â”‚
â”‚         â”œâ”€â”€ ç‰ˆæœ¬åå•†                                             â”‚
â”‚         â”œâ”€â”€ æ¥æ”¶æ–‡ä»¶åˆ—è¡¨                                          â”‚
â”‚         â””â”€â”€ HTTP GET ä¸‹è½½æ–‡ä»¶                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ§ª æµ‹è¯•ç­–ç•¥

### å•å…ƒæµ‹è¯•è¦†ç›–

| å±‚çº§ | æ¨¡å— | æµ‹è¯•æ–‡ä»¶ | è¦†ç›–å†…å®¹ |
|------|------|----------|----------|
| L0 | Crypto | `ble_security.rs` | ECDH, AES-CTR, å…¬é’¥æ ¼å¼ |
| L1 | BLE | `mod.rs` | UUID, DeviceInfo åºåˆ—åŒ– |
| L2 | WiFi | `mod.rs` | P2pInfo åºåˆ—åŒ–, å‡­è¯ç”Ÿæˆ |
| L3 | Transfer | `protocol.rs` | WsMessage è§£æ |

### é›†æˆæµ‹è¯•

| æµ‹è¯•æ–‡ä»¶ | è¦†ç›–åœºæ™¯ |
|----------|----------|
| `tests/integration_tests.rs` | ç«¯åˆ°ç«¯åŠ å¯†, ECDH æ¡æ‰‹ |

### Mock æµ‹è¯•

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Mock æµ‹è¯•è¾¹ç•Œ                            â”‚
â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚  â”‚  MockNmClient    â”‚     â”‚   MockBleClient  â”‚              â”‚
â”‚  â”‚  (æ¨¡æ‹Ÿ D-Bus)    â”‚     â”‚   (æ¨¡æ‹Ÿ BLE)     â”‚              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚           â”‚                        â”‚                         â”‚
â”‚           â–¼                        â–¼                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚            WiFiP2pSender / Receiver          â”‚           â”‚
â”‚  â”‚                 (çœŸå®é€»è¾‘æµ‹è¯•)                 â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“‹ ç‰ˆæœ¬å…¼å®¹æ€§

| ç»„ä»¶ | æœ€ä½ç‰ˆæœ¬ | å¤‡æ³¨ |
|------|----------|------|
| Rust | 1.75+ | éœ€è¦ `let-else` ç­‰ç‰¹æ€§ |
| NetworkManager | 1.16+ | D-Bus API ç¨³å®šæ€§ |
| BlueZ | 5.50+ | bluer crate è¦æ±‚ |
| Linux Kernel | 5.4+ | BLE/WiFi P2P æ”¯æŒ |

---

**æ–‡æ¡£ç‰ˆæœ¬**: 1.0  
**æœ€åæ›´æ–°**: 2026-01-20  
**ä½œè€…**: Cattysend å¼€å‘å›¢é˜Ÿ
